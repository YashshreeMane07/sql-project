<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatSQL - Ask AI</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
  
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script src="https://unpkg.com/phosphor-icons"></script>
      <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
   <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
      :root {
        --primary-green-dark: #0d4a33;
        --primary-green-medium: #1e8f5b;
        --primary-green-light: #d8f5e5;
        --background-light: #f5f7f8;
        --card-white: #ffffff;
        --text-dark: #1a1d1f;
        --text-gray: #6d737a;
        --border-light: #e1e4e8;
      }

      /* --- MIDDLE LAYOUT --- */
      .dashboard-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 100px; /* Space for fixed chat bar */
      }

      .result-rect {
        background: var(--card-white);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-light);
        min-height: 80px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
      }

      .data-display-container {
        background: var(--card-white);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-light);
        min-height: 250px;
        display: flex;
        flex-direction: column;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .data-table th,
      .data-table td {
        border: 1px solid var(--border-light);
        padding: 12px;
        text-align: left;
        color: var(--text-gray);
      }

      .placeholder-text {
        text-align: center;
        color: var(--text-gray);
        margin-top: auto;
        margin-bottom: auto;
        font-style: italic;
      }

      .result-rect h3,
      .data-display-container h3 {
        font-size: 14px;
        color: var(--primary-green-dark);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--primary-green-light);
        padding-bottom: 5px;
      }

      .llm-output {
        color: var(--text-gray);
        font-size: 14px;
        line-height: 1.6;
      }

      .action-cards {
        display: flex;
        gap: 20px;
        justify-content: flex-start;
      }

      .action-card {
        background: var(--primary-green-light);
        padding: 15px 30px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--primary-green-dark);
        transition: 0.3s;
      }

      .action-card:hover {
        background: #c2eed6;
      }

      /* --- CENTERED MODAL POPUP --- */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal-card {
  background: white;
  width: 420px;     /* BIG box */
  max-width: 90%;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

      .modal-header {
        background: var(--primary-green-dark);
        color: white;
        padding: 15px;
        font-weight: 600;
        text-align: center;
      }

     .option-btn {
  display: block;
  width: 100%;
  padding: 20px 25px;
  font-size: 18px;
  cursor: pointer;
  border-bottom: 1px solid #e1e4e8;
}
      .option-btn:last-child {
        border-bottom: none;
      }
      .option-btn:hover {
        background: var(--primary-green-light);
      }

      /* --- ORIGINAL CHAT INPUT BAR --- */
      .chat-input-wrapper {
        position: fixed;
        bottom: 30px;
        left: 292px; /* sidebar width + padding */
        right: 32px;
        display: flex;
        justify-content: center;
      }

      .chat-input-container {
        width: 100%;
        max-width: 800px;
        background: var(--card-white);
        border: 1px solid var(--border-light);
        border-radius: 50px;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      }

      .chat-input-container input {
        flex: 1;
        border: none;
        outline: none;
        padding: 10px;
        font-size: 15px;
      }

      .voice-btn,
      .send-btn {
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        padding: 5px;
        transition: 0.2s;
      }

      .voice-btn {
        color: var(--text-gray);
      }
      .send-btn {
        color: var(--primary-green-medium);
      }
      .send-btn:hover {
        transform: scale(1.1);
      }
      /* Hide action container by default */
      #actionContainer {
        display: none;
        margin-top: 15px;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .action-cards {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .action-card {
        background: var(--primary-green-light);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 13px;
        color: var(--primary-green-dark);
        transition: 0.3s;
        border: 1px solid transparent;
      }

      .action-card:hover {
        background: #c2eed6;
        border-color: var(--primary-green-medium);
      }
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 999;
      }

      .modal-box {
        background: #fff;
        width: 500px;
        max-width: 90%;
        border-radius: 10px;
        padding: 20px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

     #explanationModal .modal-header button {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: white;
}

      .modal-body {
        margin-top: 15px;
        line-height: 1.6;
      }
      .spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 3px solid #d8f5e5;
  border-top: 3px solid #1e8f5b;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Voice recording popup */
.voice-record-card {
  background: white;
  padding: 50px 40px;
  border-radius: 20px;
  text-align: center;
  width: 420px;          /* BIG width */
  max-width: 90%;
  box-shadow: 0 25px 80px rgba(0,0,0,0.35);
  animation: popupScale 0.25s ease;
}

@keyframes popupScale {
  from {
    transform: scale(0.8);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.voice-icon {
  font-size: 90px;      /* BIG mic */
  color: #1e8f5b;
  margin-bottom: 20px;
  animation: micPulse 1.2s infinite;
}

@keyframes micPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.25); }
  100% { transform: scale(1); }
}
.voice-text {
  font-size: 26px;
  font-weight: 700;
  margin-bottom: 25px;
}

/* animated bars */
.voice-animation {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin-bottom: 20px;
}

.voice-animation span {
  width: 10px;
  height: 35px;
  background: #1e8f5b;
  border-radius: 6px;
  animation: voiceWave 1s infinite ease-in-out;
}

.voice-animation span:nth-child(2) {
  animation-delay: 0.2s;
}

.voice-animation span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes voiceWave {
  0%,100% { height: 20px; }
  50% { height: 40px; }
}

.voice-stop-btn {
  background: #1e8f5b;
  color: white;
  border: none;
  padding: 14px 30px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
}

/* Bigger modal */
#exportModal {
  width: 520px;
  border-radius: 16px;
  overflow: hidden;
}

/* Export buttons */
.export-btn {
  display: flex;
  align-items: center;
  gap: 15px;
  width: 100%;
  padding: 22px;
  font-size: 20px;
  border: none;
  background: white;
  cursor: pointer;
  transition: all 0.25s ease;
  border-bottom: 1px solid #e5e7eb;
}

/* Icon */
.export-icon {
  font-size: 28px;
  color: #0d4a33;
}

/* Hover effect */
.export-btn:hover {
  background: #d8f5e5;
  transform: scale(1.02);
}

/* Click effect */
.export-btn:active {
  transform: scale(0.98);
}

.viz-btn {
  display: flex;
  align-items: center;
  gap: 15px;
  width: 100%;
  padding: 22px;
  font-size: 20px;
  border: none;
  background: white;
  cursor: pointer;
  transition: 0.25s;
  border-bottom: 1px solid #e5e7eb;
}

.viz-btn:hover {
  background: #d8f5e5;
  transform: scale(1.02);
}

.viz-icon {
  font-size: 28px;
  color: #0d4a33;
}
    </style>

  </head>
  
  <body>
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
     <div class="modal-card" id="exportModal">

  <div class="modal-header">
    Export Data By
  </div>

  <button class="export-btn" onclick="exportData('csv')">
    <i class="ph ph-file-csv export-icon"></i>
    <span>CSV</span>
  </button>

  <button class="export-btn" onclick="exportData('pdf')">
    <i class="ph ph-file-pdf export-icon"></i>
    <span>PDF</span>
  </button>

  <button class="export-btn" onclick="exportData('excel')">
    <i class="ph ph-file-xls export-icon"></i>
    <span>Excel</span>
  </button>

  <button class="export-btn" onclick="exportData('json')">
    <i class="ph ph-brackets-curly export-icon"></i>
    <span>JSON</span>
  </button>

</div>

      <!-- VISUALIZE MODAL -->
      <div
        class="modal-card"
        id="vizModal"
        onclick="event.stopPropagation()"
        style="display: none"
      >
        <div class="modal-header">Visualize Data By</div>
        <button class="viz-btn" onclick="renderChart('bar')">
  <i class="ph ph-chart-bar viz-icon"></i>
  <span>Bar Chart</span>
</button>

<button class="viz-btn" onclick="renderChart('line')">
  <i class="ph ph-chart-line viz-icon"></i>
  <span>Line Chart</span>
</button>

<button class="viz-btn" onclick="renderChart('pie')">
  <i class="ph ph-chart-pie viz-icon"></i>
  <span>Pie Chart</span>
</button>

<button class="viz-btn" onclick="renderChart('histogram')">
  <i class="ph ph-chart-bar-horizontal viz-icon"></i>
  <span>Histogram</span>
</button>
      </div>
    </div>

 <aside class="sidebar">

    <!-- BRAND (Logo + Name) -->
    <div class="brand">
        <img src="{{ url_for('static', filename='sql_logo.png') }}" 
             alt="Logo" 
             class="brand-logo-img" />
        
    </div>

    <div class="menu-label">MENU</div>

   <ul class="nav-list">

<li class="nav-item {{ 'active' if request.path == '/dashboard' else '' }}"
    onclick="window.location.href='/dashboard'">
    <i class="ph ph-squares-four"></i>
    <span>Overview</span>
</li>

<li class="nav-item {{ 'active' if request.path == '/' else '' }}"
    onclick="window.location.href='/'">
    <i class="ph ph-sparkle"></i>
    <span>Ask AI</span>
</li>

<li class="nav-item {{ 'active' if request.path == '/history' else '' }}"
    onclick="window.location.href='/history'">
    <i class="ph ph-clock-counter-clockwise"></i>
    <span>Query History</span>
</li>

<li class="nav-item {{ 'active' if request.path == '/templates_page' else '' }}"
    onclick="window.location.href='/templates_page'">
    <i class="ph ph-copy-simple"></i>
    <span>Templates</span>
</li>

</ul>

  <!-- GENERAL SECTION -->
<div class="menu-label" style="margin-top: 20px">GENERAL</div>

<ul class="nav-list">

<li class="nav-item {{ 'active' if request.path == '/profile' else '' }}"
    onclick="window.location.href='/profile'">
    <i class="ph ph-user"></i>
    <span>Profile</span>
</li>

<li class="nav-item {{ 'active' if request.path == '/help' else '' }}"
    onclick="window.location.href='/help'">
    <i class="ph ph-book"></i>
    <span>Help/Tutorial</span>
</li>

<li class="nav-item {{ 'active' if request.path == '/settings' else '' }}"
    onclick="window.location.href='/settings'">
    <i class="ph ph-gear"></i>
    <span>Settings</span>
</li>

<li class="nav-item"
    onclick="handleLogout()">
    <i class="ph ph-sign-out"></i>
    <span>Logout</span>
</li>

</ul>
</aside>

    <main class="main-content">
      <header>
        <div class="search-bar">
          <i class="ph ph-magnifying-glass"></i
          ><input type="text" placeholder="Search..." />
        </div>
        <div class="header-actions">
          <button class="icon-btn"><i class="fa-regular fa-bell"></i></button>
          <div class="user-profile">
            <div class="user-info">
              <div class="user-name">Username</div>
              <div class="user-email">email@id.com</div>
            </div>
            <img
              src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=100&q=80"
              alt="Profile"
              class="avatar"
            />
          </div>
        </div>
      </header>

      <div class="dashboard-container">
        <!-- CHAT AREA -->
        <div
          id="chat-box"
          style="display: flex; flex-direction: column; gap: 10px"
        ></div>

        <!-- GENERATED SQL -->
        <div class="result-rect" id="sqlResult">
          <h3>Generated SQL</h3>
          <div class="llm-output placeholder-text" id="sqlOutput">
    SQL will appear here
</div>
        </div>

        <!-- ACTION BUTTONS (EXPORT / VISUALIZE) -->
        <div id="actionContainer" style="display: none">
          <div class="action-cards">
            <div class="action-card" onclick="openExplanationModal()">
              <i class="ph ph-info"></i> Explain Query
            </div>

            <div class="action-card" onclick="openModal('exportModal')">
              <i class="ph ph-download-simple"></i> Export Data
            </div>

            <div class="action-card" onclick="openModal('vizModal')">
              <i class="ph ph-chart-bar"></i> Visualize
            </div>
          </div>
        </div>

        <!-- QUERY RESULT -->
        <!-- QUERY RESULT -->
        <div class="data-display-container" id="tableResult">
          <h3>Query Result</h3>
          <div class="placeholder-text">Data will appear here</div>
        </div>

        <!-- VISUALIZATION RESULT (ONLY ONE) -->
        <!-- VISUALIZATION RESULT (ONLY ONE) -->
<div
  id="chartContainer"
  style="
    display: none;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border-light);
    margin-top: 20px;
  "
>
  <h3>Visualization</h3>
  <div style="height: 400px; width: 100%; position: relative;">
      <canvas id="dynamicChart"></canvas>
  </div>
</div>


        <!-- CHAT INPUT -->
        <div class="chat-input-wrapper">
          <div class="chat-input-container">
         
            <button class="voice-btn" onclick="openVoiceModal()">
  <i class="ph ph-microphone"></i>
</button>


            <input type="text" placeholder="ASK AI..." id="userInput" />

            <button class="send-btn" onclick="handleSend()">
              <i class="ph ph-paper-plane-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
    <script>
      let lastQueryData = [];
let chartInstance = null;

let currentPage = 1;
let rowsPerPage = 6; // change if needed

      function openModal(id) {
        document.getElementById("modalOverlay").style.display = "flex";

        // hide both first
        document.getElementById("exportModal").style.display = "none";
        document.getElementById("vizModal").style.display = "none";

        // show only selected
        document.getElementById(id).style.display = "block";
      }

      function closeModal() {
        document.getElementById("modalOverlay").style.display = "none";
        document.getElementById("exportModal").style.display = "none";
        document.getElementById("vizModal").style.display = "none";
      }

      function saveQueryToHistory(question) {
        const history = JSON.parse(localStorage.getItem("queryHistory")) || [];

        history.unshift({
          question: question,
          time: new Date().toLocaleString(),
        });

        // keep only last 20 queries
        localStorage.setItem(
          "queryHistory",
          JSON.stringify(history.slice(0, 20))
        );
      }
      function handleSend() {

    // ===== FIX 2 START =====
    document.getElementById("chartContainer").style.display = "none";

    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    // ===== FIX 2 END =====

    const input = document.getElementById("userInput");
    const question = input.value.trim();
    // Show spinner inside SQL box
document.getElementById("sqlOutput").innerHTML =
    '<div class="spinner"></div>';
    if (!question) return;

    // rest of your code continues...


    // UI: Add user question to chat box
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML += `
        <div style="align-self:flex-end;background:#1e8f5b;color:white;
        padding:10px 14px;border-radius:14px;max-width:70%;
        margin-left:auto;margin-bottom:10px;font-size:14px;">
            ${question}
        </div>`;

   // Reset UI states
    document.getElementById("actionContainer").style.display = "none";
    
    // FIX: Using relative path "/ask" instead of hardcoded port 5501
    // This allows Flask to handle the routing regardless of what port it's on
    fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question }),
    })
    .then((res) => {
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        return res.json();
    })
    .then((data) => {
        // 1. Store explanation globally
        lastExplanation = data.explanation || "No explanation available.";

        // 2. Extract and display the SQL
        const generatedSQL = data.generated_sql || "No SQL generated";
     document.getElementById("sqlOutput").innerText = generatedSQL;;
        // 3. FIX: Save BOTH question and SQL to history
        logToHistory(question, generatedSQL);

        // Toggle action buttons visibility
        if (data.db_result && data.db_result.type === "select") {
            document.getElementById("actionContainer").style.display = "block";
        } else {
            document.getElementById("actionContainer").style.display = "none";
        }

        // 4. Handle Table Results
        const container = document.getElementById("tableResult");
        if (data.db_result && data.db_result.type === "select") {
            lastQueryData = data.db_result.rows;

            if (!lastQueryData || !lastQueryData.length) {
                container.innerHTML = "<h3>Query Result</h3><div class='placeholder-text'>No data found</div>";
                return;
            }

           currentPage = 1;
renderTablePage();
        }
    })
    .catch(err => {
        console.error("Fetch Error:", err);
        document.querySelector("#sqlResult .llm-output").innerText = "Error connecting to server. Make sure your Python app is running.";
    });
    // Clear input field
    input.value = "";
}
function renderTablePage() {

    const container = document.getElementById("tableResult");

    if (!lastQueryData.length) {
        container.innerHTML =
            "<h3>Query Result</h3><div class='placeholder-text'>No data</div>";
        return;
    }

    const cols = Object.keys(lastQueryData[0]);

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    const pageRows = lastQueryData.slice(start, end);

    let html = "<table class='data-table'><tr>";

    cols.forEach(col => {
        html += `<th>${col}</th>`;
    });

    html += "</tr>";

    pageRows.forEach(row => {
        html += "<tr>";
        cols.forEach(col => {
            html += `<td>${row[col] ?? "NULL"}</td>`;
        });
        html += "</tr>";
    });

    html += "</table>";

    const totalPages = Math.ceil(lastQueryData.length / rowsPerPage);

    html += `
        <div style="margin-top:15px;display:flex;gap:10px;align-items:center;">
            <button onclick="prevPage()" ${currentPage===1?'disabled':''}>
                Prev
            </button>

            <span>
                Page ${currentPage} of ${totalPages}
            </span>

            <button onclick="nextPage()" ${currentPage===totalPages?'disabled':''}>
                Next
            </button>
        </div>
    `;

    container.innerHTML = "<h3>Query Result</h3>" + html;
}

function nextPage() {

    const totalPages =
        Math.ceil(lastQueryData.length / rowsPerPage);

    if (currentPage < totalPages) {

        currentPage++;

        renderTablePage();
    }
}

function prevPage() {

    if (currentPage > 1) {

        currentPage--;

        renderTablePage();
    }
}
      /* ================== CHART LOGIC ================== */

    /* ================== FIXED CHART LOGIC ================== */
function renderChart(type) {
    closeModal(); // Close the popup

    // 0. Safety check
    if (!lastQueryData || !lastQueryData.length) {
        alert("No data to visualize. Please run a query first.");
        return;
    }

    // 1. Show chart container
    const container = document.getElementById("chartContainer");
    container.style.display = "block";

    // 2. Get column names
    const keys = Object.keys(lastQueryData[0]);

    // 3. Find first NUMERIC column automatically
    let valueKey = null;
    for (let key of keys) {
        if (!isNaN(Number(lastQueryData[0][key]))) {
            valueKey = key;
            break;
        }
    }

    // 4. If no numeric column → block visualization
    if (!valueKey) {
        alert("This data cannot be visualized because it has no numeric values.");
        container.style.display = "none";
        return;
    }

    // 5. Use first column as labels
    const labelKey = keys[0];
    const labels = lastQueryData.map(row => row[labelKey]);
    const values = lastQueryData.map(row => Number(row[valueKey]));

    // 6. Get canvas
    const canvas = document.getElementById("dynamicChart");
    const ctx = canvas.getContext("2d");

    // 7. Destroy old chart (IMPORTANT FIX)
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }

    // 8. Create new chart
    chartInstance = new Chart(ctx, {
        type: type === "histogram" ? "bar" : type,
        data: {
            labels: labels,
            datasets: [{
                label: valueKey,
                data: values,
                backgroundColor:
                    type === "pie"
                        ? ['#1e8f5b', '#28a745', '#d8f5e5', '#0d4a33', '#c2eed6']
                        : '#1e8f5b',
                borderColor: '#1e8f5b',
                borderWidth: 1,
                borderRadius: type === 'bar' ? 6 : 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: type === 'pie',
                    position: 'bottom'
                }
            },
            scales: type !== 'pie' ? {
                y: { beginAtZero: true },
                x: { grid: { display: false } }
            } : {}
        }
    });

    // 9. Scroll to chart
    container.scrollIntoView({ behavior: "smooth" });
}

    </script>
    <script>
      let lastExplanation = "";

      async function askQuestion(question) {
        const response = await fetch("http://127.0.0.1:5501/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ question }),
        });

        const data = await response.json();

        // store explanation globally
        lastExplanation = data.explanation || "No explanation available.";

        console.log("Explanation:", lastExplanation);
      }

      function openExplanationModal() {
        document.getElementById("explanationText").innerText = lastExplanation;
        document.getElementById("explanationModal").style.display = "flex";
      }

      function closeExplanationModal() {
        document.getElementById("explanationModal").style.display = "none";
      }
      
 
document.addEventListener("DOMContentLoaded", () => {

    const inputField = document.getElementById('userInput');
    
    const pending = localStorage.getItem('pendingQuery') || 
                    localStorage.getItem('selectedTemplateSQL') || 
                    localStorage.getItem("rerunQuery");

    if (pending && inputField) {

        inputField.value = pending;

        localStorage.removeItem('pendingQuery');
        localStorage.removeItem('selectedTemplateSQL');
        localStorage.removeItem("rerunQuery");

        // auto run query
        handleSend();
    }

});
function logToHistory(question, sql) {
    let history = JSON.parse(localStorage.getItem("queryHistory")) || [];
    const newEntry = {
        question: question,
        // Ensure sql is not null or undefined before saving
        sql: sql || "No SQL generated", 
        time: new Date().toLocaleString(),
        db: "Production_Main"
    };
    history.unshift(newEntry);
    localStorage.setItem("queryHistory", JSON.stringify(history.slice(0, 20)));
}


  let recognitionInstance = null;

  function openVoiceModal() {
    document.getElementById("voiceLangModal").style.display = "flex";
  }

  function closeVoiceModal() {
    document.getElementById("voiceLangModal").style.display = "none";
  }

 function startVoiceInput(lang) {

  closeVoiceModal();

  if (!('webkitSpeechRecognition' in window)) {
    alert("Voice input not supported in this browser. Use Chrome.");
    return;
  }

  recognitionInstance = new webkitSpeechRecognition();
  recognitionInstance.lang = lang;
  recognitionInstance.continuous = false;
  recognitionInstance.interimResults = false;

  recognitionInstance.onstart = () => {

    // SHOW recording popup
    document.getElementById("voiceRecordingModal").style.display = "flex";
    document.getElementById("voiceStatusText").innerText = "Listening...";
  };

  recognitionInstance.onresult = (event) => {

    const voiceText = event.results[0][0].transcript;

    document.getElementById("userInput").value = voiceText;

    stopVoiceInput();
  };

  recognitionInstance.onerror = () => {
    stopVoiceInput();
    alert("Voice recognition failed");
  };

  recognitionInstance.onend = () => {
    stopVoiceInput();
  };

  recognitionInstance.start();
}

function stopVoiceInput() {

  if (recognitionInstance) {
    recognitionInstance.stop();
  }

  document.getElementById("voiceRecordingModal").style.display = "none";
}

  // Close modal if user clicks outside
 document.addEventListener("DOMContentLoaded", function () {
  const voiceModal = document.getElementById("voiceLangModal");
  if (voiceModal) {
    voiceModal.addEventListener("click", closeVoiceModal);
  }
});

function exportData(format) {

    if (!lastQueryData || lastQueryData.length === 0) {
        alert("No data to export");
        return;
    }

    if (format === "csv") {
        exportCSV();
    }
    else if (format === "json") {
        exportJSON();
    }
    else if (format === "excel") {
        exportExcel();
    }
    else if (format === "pdf") {
        exportPDF();
    }

    closeModal();
}

function exportCSV() {

    const cols = Object.keys(lastQueryData[0]);

    let csv = cols.join(",") + "\n";

    lastQueryData.forEach(row => {
        csv += cols.map(col => `"${row[col]}"`).join(",") + "\n";
    });

    downloadFile(csv, "query_result.csv", "text/csv");
}

function exportJSON() {

    const json = JSON.stringify(lastQueryData, null, 2);

    downloadFile(json, "query_result.json", "application/json");
}

function exportExcel() {

    const cols = Object.keys(lastQueryData[0]);

    let csv = cols.join("\t") + "\n";

    lastQueryData.forEach(row => {
        csv += cols.map(col => row[col]).join("\t") + "\n";
    });

    downloadFile(csv, "query_result.xls", "application/vnd.ms-excel");
}


function exportPDF() {

    let content = "Query Result\n\n";

    const cols = Object.keys(lastQueryData[0]);

    content += cols.join("    ") + "\n";

    lastQueryData.forEach(row => {
        content += cols.map(col => row[col]).join("    ") + "\n";
    });

    downloadFile(content, "query_result.pdf", "application/pdf");
}


function downloadFile(content, filename, type) {

    const blob = new Blob([content], { type });

    const link = document.createElement("a");

    link.href = URL.createObjectURL(blob);

    link.download = filename;

    link.click();
}


    </script>

    

    <!-- Explanation Modal -->
    <div id="explanationModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">
          <h3>Query Explanation</h3>
          <button onclick="closeExplanationModal()">✖</button>
        </div>
        <div class="modal-body">
          <p id="explanationText">Loading explanation...</p>
        </div>
      </div>
    </div>
    <!-- Voice Language Modal -->
<div class="modal-overlay" id="voiceLangModal">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">Select Voice Language</div>

   <button class="option-btn" onclick="startVoiceInput('en-IN')">
  English
</button>

<button class="option-btn" onclick="startVoiceInput('hi-IN')">
  हिन्दी
</button>

<button class="option-btn" onclick="startVoiceInput('mr-IN')">
  मराठी
</button>
  </div>
</div>

<!-- Voice Recording Modal -->
<div class="modal-overlay" id="voiceRecordingModal">
  <div class="voice-record-card" onclick="event.stopPropagation()">

    <div class="voice-icon">
      <i class="ph ph-microphone"></i>
    </div>

    <div class="voice-text" id="voiceStatusText">
      Listening...
    </div>

    <div class="voice-animation">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <button class="voice-stop-btn" onclick="stopVoiceInput()">
      Stop
    </button>

  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const pendingQuery = localStorage.getItem("pendingQuery");

    if (pendingQuery) {
        const inputBox = document.getElementById("queryInput");

        if (inputBox) {
            inputBox.value = pendingQuery;
        }

        localStorage.removeItem("pendingQuery");
    }
});
</script>
  </body>
</html>