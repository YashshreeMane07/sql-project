<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Query History</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
   <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="{{ url_for('static', filename='script.js') }}"></script>
  </head>

  <body>
    <!-- SIDEBAR -->
     <aside class="sidebar">
    <div class="brand">
      <div class="brand">
     <img src="{{ url_for('static', filename='sql_logo.png') }}" 
     alt="Logo" 
     class="brand-logo-img" />
</div>
    </div>
    <div class="menu-label">MENU</div>
    <ul class="nav-list">
    <li class="nav-item active" onclick="window.location.href='/dashboard'">
        <i class="ph ph-squares-four"></i> <span>Overview</span>
    </li>

    <li class="nav-item" onclick="window.location.href='/ask_page'">
    <i class="ph ph-sparkle"></i> <span>Ask AI</span>
</li>

    <li class="nav-item" onclick="window.location.href='/history'">
        <i class="ph ph-clock-counter-clockwise"></i> <span>Query History</span>
    </li>

    <li class="nav-item" onclick="window.location.href='/templates_page'">
        <i class="ph ph-copy-simple"></i> <span>Templates</span>
    </li>

</ul>
    <div class="menu-label" style="margin-top: 20px">GENERAL</div>
      <ul class="nav-list">
        <li class="nav-item"><i class="ph ph-user"></i><span>Profile</span></li>
        <li class="nav-item">
          <i class="ph ph-book"></i><span>Help/Tutorial</span>
        </li>
        <li class="nav-item">
          <i class="ph ph-gear"></i><span>Settings</span>
        </li>
        <li class="nav-item" onclick="handleLogout()">
    <i class="ph ph-sign-out"></i><span>Logout</span>
</li>
      </ul>
</aside>

    <!-- MAIN -->
    <main class="main-content">
      <header>
        <div class="search-bar">
          <i class="ph ph-magnifying-glass"></i>
          <input type="text" placeholder="Search..." />
        </div>

        <div class="header-actions">
          <button class="icon-btn">
            <i class="fa-regular fa-bell"></i>
          </button>

          <div class="user-profile">
            <div class="user-info">
              <div class="user-name">Username</div>
              <div class="user-email">email@id.com</div>
            </div>
            <img
              src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=100&q=80"
              class="avatar"
            />
          </div>
        </div>
      </header>

      <!-- CONTENT -->
      <div class="dashboard-container">
    <div class="welcome-section">
        <h1 class="welcome-title" style="color: #0D4A33; font-size: 24px;">Query History</h1>
        <div class="last-active">
            <div class="status-dot" style="background: #1E8F5B;"></div>
            <span style="color: #6D737A;">Status-Connected | Database-Db Main</span>
        </div>
    </div>

    <div class="history-list" id="queryHistory">
        <div class="history-item" style="background: white; border: 1px solid #E1E4E8; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #1E8F5B; font-weight: 700; font-size: 12px; background: #D8F5E5; padding: 2px 8px; border-radius: 4px;">SUCCESS</span>
                    <span style="color: #6D737A; font-size: 13px;">Jan 05, 2026 • 08:45 PM</span>
                </div>
            </div>
            
            <p style="font-weight: 600; margin: 0 0 8px 0;">"Show me the total revenue for the year 2025 grouped by month."</p>
            
            <div style="background: #F5F7F8; padding: 12px; border-radius: 6px; border-left: 4px solid #1E8F5B; font-family: monospace; font-size: 14px; position: relative;">
                <code>SELECT month, SUM(revenue) FROM sales WHERE year = 2025 GROUP BY month ORDER BY month ASC;</code>
            </div>

            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 12px; color: #6D737A;"><i class="ph ph-database"></i> DB: Production_Main | Export: CSV, PDF</span>
                <div style="display: flex; gap: 8px;">
                    <button onclick="saveAsTemplate('Total Revenue 2025', 'SELECT month...')" style="background: white; border: 1px solid #1E8F5B; color: #1E8F5B; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Save as Template</button>
                    <button style="background: #1E8F5B; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Re-run Query</button>
                </div>
            </div>
        </div>

        <div class="history-item" style="background: white; border: 1px solid #E1E4E8; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #1E8F5B; font-weight: 700; font-size: 12px; background: #D8F5E5; padding: 2px 8px; border-radius: 4px;">SUCCESS</span>
                    <span style="color: #6D737A; font-size: 13px;">Jan 04, 2026 • 11:20 AM</span>
                </div>
            </div>
            
            <p style="font-weight: 600; margin: 0 0 8px 0;">"List all users who haven't logged in for 30 days."</p>
            
            <div style="background: #F5F7F8; padding: 12px; border-radius: 6px; border-left: 4px solid #1E8F5B; font-family: monospace; font-size: 14px;">
                <code>SELECT email FROM users WHERE last_login < DATE_SUB(NOW(), INTERVAL 30 DAY);</code>
            </div>

            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 12px; color: #6D737A;"><i class="ph ph-database"></i> DB: Production_Main | Export: CSV, PDF</span>
                <div style="display: flex; gap: 8px;">
                    <button style="background: white; border: 1px solid #1E8F5B; color: #1E8F5B; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Save as Template</button>
                    <button style="background: #1E8F5B; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Re-run Query</button>
                </div>
            </div>
        </div>
    </div>
</div>
    </main>

    <!-- SCRIPT -->
  <script>
  document.addEventListener("DOMContentLoaded", loadQueryHistory);

  function loadQueryHistory() {
    // Note: The ID in your HTML was 'queryHistory', but script used 'historyList'
    const container = document.getElementById("queryHistory");
    const history = JSON.parse(localStorage.getItem("queryHistory")) || [];

    if (history.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding: 40px; background: white; border-radius: 12px; border: 1px dashed #ccc;">
            <p style="color: #6D737A;">No query history yet. Run a query in 'Ask AI' to see it here!</p>
        </div>`;
      return;
    }

    container.innerHTML = history.map((item, index) => `
      <div class="history-item" style="background: white; border: 1px solid #E1E4E8; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <div style="display: flex; gap: 10px; align-items: center;">
                  <span style="color: #1E8F5B; font-weight: 700; font-size: 12px; background: #D8F5E5; padding: 2px 8px; border-radius: 4px;">SUCCESS</span>
                  <span style="color: #6D737A; font-size: 13px;">${item.time}</span>
              </div>
              <div style="color:#6D737A; font-size:12px;">ID: #100${index}</div>
          </div>
          
          <p style="font-weight: 600; margin: 0 0 8px 0; color: #1A1D1F;">"${item.question}"</p>
          
          <div style="background: #F5F7F8; padding: 12px; border-radius: 6px; border-left: 4px solid #1E8F5B; font-family: monospace; font-size: 14px; margin-bottom: 15px;">
              <code>${item.sql}</code>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 12px; color: #6D737A;"><i class="ph ph-database"></i> DB: ${item.db || 'Production_Main'}</span>
              <div style="display: flex; gap: 8px;">
                  <button onclick="saveAsTemplate(\`${item.question}\`, \`${item.sql}\`)" 
                          style="background: white; border: 1px solid #1E8F5B; color: #1E8F5B; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                      Save as Template
                  </button>
                  <button onclick="rerunQuery(\`${item.question.replace(/`/g, '\\`')}\`)" 
                          style="background: #1E8F5B; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                      Re-run Query
                  </button>
              </div>
          </div>
      </div>
    `).join('');
  }

  // RE-RUN: Sends the SQL back to the main input box
 // RE-RUN: Sends the SQL back to the main input box
function rerunQuery(promptText) {
    localStorage.setItem("pendingQuery", promptText);
    window.location.href = "/ask_page";
}

  // SAVE TEMPLATE: Adds to the templates collection
  function saveAsTemplate(title, sqlCode) {
    let templates = JSON.parse(localStorage.getItem('myTemplates')) || [];
    
    // Check if it already exists to avoid duplicates
    const isDuplicate = templates.some(t => t.sql === sqlCode);
    if(isDuplicate) {
        alert("This query is already in your templates!");
        return;
    }

    const newEntry = {
        id: Date.now(),
        title: title.length > 30 ? title.substring(0, 30) + "..." : title,
        sql: sqlCode,
        category: "History",
        dateCreated: new Date().toLocaleDateString()
    };
    
    templates.push(newEntry);
    localStorage.setItem('myTemplates', JSON.stringify(templates));
    alert("Template Saved! Check the Templates page.");
  }
</script>
  </body>
</html>